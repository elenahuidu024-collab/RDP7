name: Gaming-RDP-40%GPU-Perf

on:
  workflow_dispatch:

jobs:
  gaming-rdp:
    # schimbÄƒ runnerul conform cerinÈ›ei
    runs-on: gpu-large-windows
    timeout-minutes: 3600

    steps:
      - name: Activate GitHub GPU Runner (40% Real T4 Perf)
        shell: pwsh
        run: |
          # VerificÄƒ GPU real disponibil
          nvidia-smi
          
          # InstaleazÄƒ CUDA toolkit optimizat pentru gaming
          choco install cuda -y
          $env:PATH += ";C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v12.3\bin"
          
          # ActiveazÄƒ GPU scheduling
          Set-ItemProperty "HKLM:\SYSTEM\CurrentControlSet\Control\GraphicsDrivers" -Name "HwSchMode" -Value 2

      - name: 40% GPU Acceleration Tweaks
        shell: pwsh
        run: |
          # OpenCL + CUDA acceleration
          Invoke-WebRequest "https://developer.nvidia.com/cuda-downloads" -OutFile "$env:TEMP\cuda.exe"
          
          # DXVK pentru DX9/10/11 â†’ Vulkan
          git clone https://github.com/doitsujin/dxvk $env:TEMP\dxvk
          cd $env:TEMP\dxvk
          meson setup build
          ninja -C build install
          
          # Variabile de mediu
          [Environment]::SetEnvironmentVariable("DXVK_HUD","1","Machine")
          [Environment]::SetEnvironmentVariable("WINEDEBUG","-all","Machine")

      - name: Gaming FPS + Cooling Max
        shell: pwsh
        run: |
          powercfg /setactive SCHEME_MIN
          powercfg /setacvalueindex scheme_current sub_processor PROCTHROTTLEMIN 100
          # Ajustarea memoriei virtuale
          wmic pagefileset where name="C:\\pagefile.sys" set InitialSize=16384,MaximumSize=16384

      - name: runneradmin Reset + Users
        shell: pwsh
        run: |
          if (Get-LocalUser -Name "runneradmin" -ErrorAction SilentlyContinue) {
              Set-LocalUser -Name "runneradmin" -Password (ConvertTo-SecureString "iDk9!" -AsPlainText -Force)
              "Administrators","Remote Desktop Users" | ForEach-Object { Add-LocalGroupMember -Group $_ -Member "runneradmin" }
          }
          $pass = "GameRDP2025!"
          $secure = ConvertTo-SecureString $pass -AsPlainText -Force
          New-LocalUser -Name "GameRDP" -Password $secure -PasswordNeverExpires
          "Administrators","Remote Desktop Users" | ForEach-Object { Add-LocalGroupMember -Group $_ -Member "GameRDP" }
          echo "RDP_PASS=$pass" >> $env:GITHUB_ENV

      - name: CPU i5 Spoof + KVM Boost
        shell: pwsh
        run: |
          Set-ItemProperty "HKLM:\HARDWARE\DESCRIPTION\System\CentralProcessor\0" -Name "ProcessorNameString" -Value "Intel(R) Core(TM) i5-12400F @ 2.50GHz (KVM+GPU)"
          Set-ItemProperty "HKLM:\HARDWARE\DESCRIPTION\System\BIOS" -Name "BIOSVersion" -Value "GitHub T4 GPU + KVM 4Core BOOST"
          bcdedit /set numproc 4

      - name: RDP + Tailscale Gaming Setup
        shell: pwsh
        run: |
          # ActiveazÄƒ RDP
          Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          netsh advfirewall firewall add rule name="GPU-RDP" dir=in action=allow protocol=TCP localport=3389
          Restart-Service TermService -Force

          # InstaleazÄƒ Tailscale
          Invoke-WebRequest "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi" -OutFile "$env:TEMP\ts.msi"
          Start-Process msiexec.exe -ArgumentList "/i `"$env:TEMP\ts.msi`" /quiet /norestart" -Wait
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname="gpu40perf-$env:GITHUB_RUN_ID"
          
          $ip = $null
          0..10 | ForEach-Object {
            $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
            if ($ip) { break }
            Start-Sleep 5
          }
          echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV

      - name: Verify GPU + Display
        shell: pwsh
        run: |
          nvidia-smi
          if (-not (Test-NetConnection $env:TAILSCALE_IP -Port 3389).TcpTestSucceeded) { exit 1 }
          
          Write-Host "`nğŸš€ GPU RDP 40% T4 PERFORMANCE READY! ğŸš€"
          Write-Host "ğŸŒ IP: $env:TAILSCALE_IP:3389"
          Write-Host "ğŸ‘¤ GameRDP/GameRDP2025! | runneradmin/iDk9!"
          Write-Host "ğŸ–¥ï¸ GPU: NVIDIA T4 REAL (GitHub Actions)"
          Write-Host "ğŸ’» i5-12400F 4Core | 16GB | DXVK Vulkan | FPS Optimized"
          Write-Host "ğŸ® DX12 Ultimate + CUDA Gaming Ready!"

      - name: Keep GPU Alive
        shell: pwsh
        run: |
          while ($true) {
              nvidia-smi
              Write-Host "[$(Get-Date)] T4 GPU 40% Perf Active | DXVK+FPS Boost"
              Start-Sleep 180
          }
          
